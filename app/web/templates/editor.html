<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AICodeMentor • Markdown Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <!-- EasyMDE CSS -->
  <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
  <style>
    body { background: #f8f9fa; }
    .navbar { box-shadow: 0 2px 6px rgba(0,0,0,.05); }
    .editor-container { max-width: 1100px; }
    .CodeMirror { min-height: 60vh; border-radius: .5rem; }
    .status-dot { width: .6rem; height: .6rem; border-radius: 50%; display: inline-block; margin-right: .4rem; }
    .status-dirty { background: #dc3545; }
    .status-clean { background: #198754; }
    .spinner { display:none; }
    .spinner.show { display:inline-block; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
  <div class="container-fluid">
    <a class="navbar-brand" href="/files"><i class="fa-solid fa-code-branch me-2"></i>AICodeMentor – Editor</a>
    <div class="ms-auto d-flex align-items-center gap-2">
      <span id="dirty-indicator" class="text-light small"><span class="status-dot status-clean"></span>Saved</span>
      <button id="reload-btn" class="btn btn-outline-light btn-sm"><i class="fa fa-rotate-right me-1"></i>Reload</button>
      <button id="save-btn" class="btn btn-success btn-sm"><i class="fa fa-floppy-disk me-1"></i>Save</button>
    </div>
  </div>
</nav>

<main class="container editor-container">
  <div id="alert-box" class="alert alert-danger d-none" role="alert"></div>
  <div id="msg-box" class="alert alert-info d-none" role="alert"></div>

  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <strong>Editing:</strong>
        <span id="filepath"></span>
      </div>
      <div>
        <span id="loader" class="spinner spinner-border spinner-border-sm text-secondary" role="status" aria-hidden="true"></span>
      </div>
    </div>
    <div class="card-body">
      <textarea id="md-editor"></textarea>
      <div class="text-muted small mt-2">
        <i class="fa fa-circle-info me-1"></i>
        Press <kbd>Ctrl</kbd>/<kbd>Cmd</kbd> + <kbd>S</kbd> to save.
      </div>
    </div>
  </div>
</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- EasyMDE JS -->
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
<script>
(function(){
  const alertEl = document.getElementById('alert-box');
  const msgEl = document.getElementById('msg-box');
  const pathEl = document.getElementById('filepath');
  const dirtyEl = document.getElementById('dirty-indicator');
  const loaderEl = document.getElementById('loader');
  const saveBtn = document.getElementById('save-btn');
  const reloadBtn = document.getElementById('reload-btn');

  // ------- helpers -------
  function showError(msg){ alertEl.textContent = msg; alertEl.classList.remove('d-none'); }
  function clearError(){ alertEl.classList.add('d-none'); }
  function showMsg(msg){ msgEl.textContent = msg; msgEl.classList.remove('d-none'); }
  function clearMsg(){ msgEl.classList.add('d-none'); }
  function encodePath(p){ return p.split('/').map(encodeURIComponent).join('/'); }
  function getParam(name){ const url = new URL(window.location.href); return url.searchParams.get(name) || ''; }
  function setDirty(isDirty){
    dirtyEl.innerHTML = isDirty
      ? '<span class="status-dot status-dirty"></span>Unsaved'
      : '<span class="status-dot status-clean"></span>Saved';
    window.onbeforeunload = isDirty ? function(){ return true; } : null;
  }
  async function fetchFollow(url, opts={}){
    let r = await fetch(url, opts);
    if(r.status === 308){
      const loc = r.headers.get('Location');
      if(loc) r = await fetch(loc, opts);
    }
    return r;
  }

  // ------- state -------
  let easyMDE = null;
  let filePath = getParam('filepath');
  let loadedText = '';

  if(!filePath){
    showError('Missing query parameter: ?filepath=<path/to/file.md>');
    return;
  }
  pathEl.textContent = filePath;

  // ------- init editor -------
  easyMDE = new EasyMDE({
    element: document.getElementById('md-editor'),
    autofocus: true,
    spellChecker: false,
    renderingConfig: { singleLineBreaks: false },
    status: false,
    toolbar: [
      'bold','italic','heading','|',
      'quote','unordered-list','ordered-list','|',
      'link','image','table','code','|',
      'preview','side-by-side','fullscreen'
    ]
  });

  easyMDE.codemirror.on('change', function(){ setDirty(easyMDE.value() !== loadedText); });

  // ------- load file -------
  async function loadFile(){
    clearError(); clearMsg();
    loaderEl.classList.add('show');
    try{
      const res = await fetchFollow(`/api/files/${encodePath(filePath)}`);
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();
      loadedText = text;
      easyMDE.value(text);
      setDirty(false);
      showMsg('File loaded.');
    } catch(err){
      showError('Failed to load file: ' + err.message);
    } finally {
      loaderEl.classList.remove('show');
    }
  }

  // ------- save file -------
  async function saveFile(){
    clearError(); clearMsg();
    loaderEl.classList.add('show');
    try{
      const body = new Blob([easyMDE.value()], { type: 'text/plain; charset=utf-8' });
      const res = await fetchFollow(`/api/files/${encodePath(filePath)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain; charset=utf-8' },
        body
      });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      loadedText = easyMDE.value();
      setDirty(false);
      showMsg('Saved successfully.');
    } catch(err){
      showError('Save failed: ' + err.message);
    } finally {
      loaderEl.classList.remove('show');
    }
  }

  // ------- wire buttons / shortcuts -------
  reloadBtn.onclick = loadFile;
  saveBtn.onclick = saveFile;
  document.addEventListener('keydown', function(e){
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's'){
      e.preventDefault();
      saveFile();
    }
  });

  // initial load
  loadFile();
})();
</script>
</body>
</html>